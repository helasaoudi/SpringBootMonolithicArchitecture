<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Liste des Films</title>
    <!-- Int√©grer Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">üé¨ Liste des Films</h1>


    <!-- Bouton et barre de recherche -->
    <div class="d-flex justify-content-between mb-3">
        <a href="/add-movie-page" class="btn btn-success">Ajouter un Film</a>

        <div class="d-flex">
            <input id="search-genre" type="text" class="form-control me-2" placeholder="Rechercher par genre...">
            <button class="btn btn-outline-primary" onclick="searchByGenre()">Rechercher</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle bg-white">
            <thead class="table-dark">
            <tr>
                <th>Titre</th>
                <th>Genre</th>
                <th>Date de sortie</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="movies-table">
            <!-- Rempli dynamiquement par JS -->
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                √ätes-vous s√ªr de vouloir supprimer ce film ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
    let movieIdToDelete = null;
    async function loadMovies() {
        const response = await fetch('/movies');
        const movies = await response.json();
        displayMovies(movies);
    }

    function displayMovies(movies) {
        const table = document.getElementById('movies-table');
        table.innerHTML = '';
        movies.forEach(movie => {
            table.innerHTML += `
                <tr>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.releaseDate}</td>
                    <td>${movie.description}</td>
                    <td>
                        <a href="/update-movie-page/${movie.id}" class="btn btn-primary btn-sm me-2">Modifier</a>
                        <button class="btn btn-danger btn-sm" onclick="openDeleteModal(${movie.id})">Supprimer</button>

                    </td>
                </tr>`;
        });
    }

    // Ouvre la modale de confirmation et stocke l'ID du film √† supprimer
    function openDeleteModal(id) {
        movieIdToDelete = id;
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        modal.show();
    }

    // Supprimer le film apr√®s confirmation
    document.getElementById('confirmDeleteButton').addEventListener('click', async function() {
        if (movieIdToDelete !== null) {
            await fetch('/movies/' + movieIdToDelete, {
                method: 'DELETE'
            });
            loadMovies(); // Recharge la liste apr√®s suppression
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            modal.hide(); // Cache la modale apr√®s suppression
        }
    });

    async function searchByGenre() {

        const genreInput = document.getElementById('search-genre').value.trim();
        if (genreInput === '') {
            loadMovies(); // Si champ vide, recharger tous les films
        } else {
            try {
                const response = await fetch('/movies/genre/' + encodeURIComponent(genreInput));
                if (response.ok) {
                    const movies = await response.json();
                    displayMovies(movies);
                } else {
                    alert("Erreur lors de la recherche !");
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert("Erreur lors de la recherche !");
            }
        }
    }
/*
    async function deleteMovie(id) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce film ?')) {
            await fetch('/movies/' + id, {
                method: 'DELETE'
            });
            loadMovies(); // Recharge apr√®s suppression
        }
    }
*/
    window.onload = loadMovies;
</script>

<!-- Bootstrap JS (optionnel pour certains effets) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
